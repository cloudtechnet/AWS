# âœ… Module 6: High Availability & Design Best Practices

## ğŸ”· Topic: **Redundancy in Route Tables**

---

### ğŸ§  What Is Redundancy in Route Tables?

In AWS, **Route Tables** define how traffic flows within your VPC. **Redundancy in Route Tables** ensures **continued network traffic flow** even when:

* A **primary resource (like NAT, VPN, or EC2)** goes down
* There is **AZ failure**
* You need **multiple fault-tolerant paths**

This is especially important for production environments with **multi-AZ, multi-subnet setups** where **single points of failure must be avoided**.

---

## âœ… Why Is Route Table Redundancy Important?

| Feature                | Description                                    |
| ---------------------- | ---------------------------------------------- |
| ğŸ›¡ï¸ Fault Tolerance    | Avoid failure due to single route or AZ outage |
| ğŸš€ High Availability   | Ensure resources are reachable at all times    |
| ğŸ” Resilient Routing   | Traffic can reroute to backup paths            |
| ğŸŒ Hybrid Connectivity | Useful in VPN + Direct Connect scenarios       |

---

## âœ… Key AWS Components for Redundant Routing

| Component             | Role in Redundancy                                    |
| --------------------- | ----------------------------------------------------- |
| Multiple NAT Gateways | One per AZ for outbound internet redundancy           |
| Multiple VPN Tunnels  | Used in Site-to-Site VPN (2 tunnels per connection)   |
| Transit Gateway       | Centralized and resilient hub-and-spoke routing       |
| Route Tables          | Define and switch between primary and secondary paths |

---

## ğŸ§± Architecture: Redundant Route Table Setup with VPN

Weâ€™ll simulate a **high-availability VPN setup** using AWS **Site-to-Site VPN** with **two tunnels** connected to a **Virtual Private Gateway (VGW)**, and we'll use **Route Table failover** to test redundancy.

---

### ğŸ”¹ Architecture Diagram

```
  On-Premises (Simulated)
         â”‚
   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
   â”‚  VPN A    â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚  VPN B    â”‚ (Backup Tunnel)
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚  VGW      â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ AWS VPC Route â”‚  â† With 2 static routes
  â”‚ Table         â”‚     (1 active, 1 standby)
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Real-Time Lab: Redundant Route Tables with VPN Failover

---

### ğŸ¯ Objective

Simulate redundant routing using **2 VPN tunnels** for **on-prem connectivity** and **static route priorities** in a **VPC route table**.

---

## ğŸ”¸ Step-by-Step Lab Instructions

---

### ğŸ”¹ Step 1: Create the AWS Side

#### A. VPC Setup

1. Create VPC: `10.0.0.0/16`
2. Create subnet: `10.0.1.0/24`
3. Launch an EC2 instance in this subnet (used to simulate private communication)

#### B. Create Virtual Private Gateway (VGW)

1. Go to **VPC â†’ Virtual Private Gateways**
2. Create VGW and attach it to the above VPC

---

### ğŸ”¹ Step 2: Create Customer Gateway (Simulated)

Use **StrongSwan** EC2 in another VPC or use a real on-prem appliance.

1. Launch **Ubuntu EC2** and assign **Elastic IP** (this is your CGW IP)
2. Install and configure **StrongSwan** (as shown in hybrid labs)

---

### ğŸ”¹ Step 3: Create VPN Connection with Redundant Tunnels

1. Go to **VPN Connections â†’ Create VPN**

2. Set:

   * **Target Gateway**: VGW
   * **Customer Gateway IP**: Elastic IP of your simulated on-prem EC2
   * Routing: **Static**
   * Routes: `192.168.10.0/24` (simulated on-prem network)

3. AWS will generate:

   * Two **Tunnel IPs**
   * Two **PSKs** (pre-shared keys)
   * You can download configuration for StrongSwan

---

### ğŸ”¹ Step 4: Configure Both VPN Tunnels in StrongSwan

Define **2 connections** in `/etc/ipsec.conf`

```conf
conn tunnel1
  left=ElasticIP
  right=<Tunnel1_IP>
  leftsubnet=192.168.10.0/24
  rightsubnet=10.0.0.0/16
  authby=secret
  auto=start

conn tunnel2
  left=ElasticIP
  right=<Tunnel2_IP>
  leftsubnet=192.168.10.0/24
  rightsubnet=10.0.0.0/16
  authby=secret
  auto=start
```

In `/etc/ipsec.secrets`:

```
ElasticIP Tunnel1_IP : PSK "yourkey"
ElasticIP Tunnel2_IP : PSK "yourkey"
```

Restart VPN:

```bash
sudo ipsec restart
```

---

### ğŸ”¹ Step 5: Modify Route Table for Redundancy

1. Go to **VPC â†’ Route Tables**
2. Add **two static routes** to `192.168.10.0/24`:

   * Route 1 â†’ VPN Tunnel 1 (primary)
   * Route 2 â†’ VPN Tunnel 2 (lower priority)

âš ï¸ AWS will automatically use the **first available tunnel**, and if one fails, **routing will automatically switch**.

---

## âœ… Final Test â€“ How to Check the Redundancy

### ğŸ”¸ Step 6: From AWS EC2, test to on-prem subnet

```bash
ping 192.168.10.10
```

âœ… If tunnel 1 is UP â†’ packet goes via **VPN Tunnel 1**

Now, **disable Tunnel 1** in StrongSwan or AWS Console:

```bash
sudo ipsec down tunnel1
```

Retry `ping` â†’ packets will reroute via **Tunnel 2** (redundant path)

âœ… AWS **Route Table Failover** is working.

---

## âœ… Expected Output

| Test Action                     | Expected Result                       |
| ------------------------------- | ------------------------------------- |
| `ping` to on-prem (Tunnel 1 up) | Success via Tunnel 1                  |
| Disable Tunnel 1                | Route table switches to Tunnel 2      |
| `ping` again                    | Success via Tunnel 2                  |
| Check VPN console               | Tunnel 1 â€œdownâ€, Tunnel 2 â€œupâ€        |
| EC2 Logs                        | Still receiving response from on-prem |

---

## ğŸ§  Summary for Students

| Concept     | Key Idea                            |
| ----------- | ----------------------------------- |
| Redundancy  | Multiple routes ensure connectivity |
| VPN Tunnel  | Dual-tunnel site-to-site VPN        |
| Route Table | Automatically uses available tunnel |
| StrongSwan  | Simulates on-prem gateway           |

---

## ğŸ–¼ï¸ Slide Visual (For Teaching)

```
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ VPN Tunnel 1 â”‚  â† Primary
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   VGW in AWS   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Route Table   â”‚
â”‚  1st: Tunnel 1 â”‚
â”‚  2nd: Tunnel 2 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–¼
   AWS EC2/VPC
```

---

## ğŸ§¹ Cleanup Steps

* Delete EC2 instances (both ends)
* Delete VPN connection, VGW, CGW
* Delete route tables if not reused
* Remove customer gateway config


