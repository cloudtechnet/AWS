# âœ… Module 6: High Availability & Design Best Practices

## ğŸ”· Topic: **NAT Gateway High Availability (HA) Design**

---

## ğŸ”¹ What is a NAT Gateway?

### âœ… Definition:

A **NAT (Network Address Translation) Gateway** enables **instances in a private subnet** to initiate **outbound connections to the internet** (e.g., for OS updates, downloading packages), while **blocking unsolicited inbound traffic from the internet**.

---

## âœ… Why NAT Gateway HA Is Important?

By default, NAT Gateway is deployed **per Availability Zone**. If the AZ containing the NAT Gateway goes down, **instances in that zone lose internet access** unless a backup NAT Gateway exists in another AZ.

---

### âœ… Goal of HA NAT Design:

* Avoid **single point of failure**
* Maintain **internet access** for private instances in all AZs
* **Distribute traffic** for better resilience

---

## ğŸ§  NAT Gateway Design Comparison

| Design          | Description                    | Drawback                            |
| --------------- | ------------------------------ | ----------------------------------- |
| âŒ Single NAT GW | Only one NAT Gateway in one AZ | AZ failure = loss of internet       |
| âœ… HA NAT GW     | One NAT Gateway per AZ         | Slightly higher cost, but resilient |

---

## ğŸ§± Architecture Diagram: HA NAT Gateway

```
                         Internet
                             â–²
                             â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   IGW (Internet)   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚     Public Subnets  â”‚
                â”‚ (AZ-a & AZ-b)       â”‚
                â”‚ NAT-A     NAT-B     â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Private Subnet-A   â”‚             â”‚ Private Subnet-B   â”‚
â”‚ (Route to NAT-A)   â”‚             â”‚ (Route to NAT-B)   â”‚
â”‚ EC2-A              â”‚             â”‚ EC2-B              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Step-by-Step Real-Time Lab: NAT Gateway with HA Setup

---

### ğŸ”¸ Step 1: Create VPC and Subnets

1. **Create a VPC** (e.g., `10.0.0.0/16`)
2. Create 2 **Public Subnets**:

   * Public-A: `10.0.1.0/24` in **AZ-a**
   * Public-B: `10.0.2.0/24` in **AZ-b**
3. Create 2 **Private Subnets**:

   * Private-A: `10.0.3.0/24` in **AZ-a**
   * Private-B: `10.0.4.0/24` in **AZ-b**

---

### ğŸ”¸ Step 2: Create and Attach an Internet Gateway (IGW)

1. Go to **VPC â†’ Internet Gateways**
2. Create IGW and attach it to your VPC

---

### ğŸ”¸ Step 3: Create 2 NAT Gateways (1 per AZ)

1. Go to **VPC â†’ NAT Gateways**
2. **Create NAT Gateway-A** in Public-A

   * Allocate an **Elastic IP**
3. **Create NAT Gateway-B** in Public-B

   * Allocate another **Elastic IP**

---

### ğŸ”¸ Step 4: Configure Route Tables

#### A. Route Table for Public Subnets

* Destination: `0.0.0.0/0` â†’ **IGW**
* Associate with both **Public-A and Public-B**

#### B. Route Table for Private-A:

* Destination: `0.0.0.0/0` â†’ **NAT Gateway-A**
* Associate with **Private Subnet-A**

#### C. Route Table for Private-B:

* Destination: `0.0.0.0/0` â†’ **NAT Gateway-B**
* Associate with **Private Subnet-B**

---

### ğŸ”¸ Step 5: Launch EC2 Instances in Private Subnets

1. Launch **EC2-A** in Private-A (AZ-a)
2. Launch **EC2-B** in Private-B (AZ-b)
3. Use **Amazon Linux 2**, disable auto-assign public IP
4. Use the same key pair to SSH

In **Security Group**, allow:

* **Outbound:** All
* **Inbound:** Only ICMP and SSH from your jump box or bastion EC2 (in public subnet)

---

### ğŸ”¸ Step 6: Launch Bastion Host (Public EC2)

1. Launch one **EC2 instance in Public-A**
2. Assign public IP
3. SSH into it â†’ use it as jump box to connect to private EC2s

---

### ğŸ”¸ Step 7: Test Internet Access from Private EC2s

SSH into EC2-A and EC2-B via bastion and run:

```bash
curl https://www.google.com
```

âœ… You should get HTML content â†’ this confirms private instances have internet via NAT Gateways.

---

## âœ… High Availability Test

Now simulate a failure:

1. **Manually disable NAT Gateway-A** (delete it or stop routing to it)
2. Try accessing internet from EC2-A:

   * âŒ You should lose connectivity
3. Re-route EC2-Aâ€™s private subnet to use **NAT Gateway-B**

   * Update route table of Private-A
   * Add route `0.0.0.0/0` â†’ NAT Gateway-B

```bash
curl https://www.google.com
```

âœ… Now EC2-A can access internet again via **NAT-B**.

---

## âœ… Final Check: What Students Should Validate

| Check                     | Expected Output                         |
| ------------------------- | --------------------------------------- |
| EC2-A & EC2-B `curl` test | Get HTTP 200/HTML response              |
| Route Table Check         | Each private subnet uses its AZâ€™s NAT   |
| NAT GW Monitoring         | CloudWatch metrics show bytes processed |
| AZ Failure Simulation     | Traffic rerouted to secondary NAT       |

---

## ğŸ§  Summary for Students

| Component              | Purpose                              |
| ---------------------- | ------------------------------------ |
| NAT Gateway (1 per AZ) | Enables private subnet internet      |
| Private Subnet         | Secure app layer, no public IP       |
| Public Subnet          | Hosts NAT and Bastion host           |
| Route Tables           | Direct internet-bound traffic to NAT |

---

## ğŸ–¼ï¸ Slide Visual Summary

```
                   Internet
                       â–²
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚          â”‚          â”‚
         NAT-A      NAT-B     (1 per AZ)
            â–²          â–²
        â”Œâ”€â”€â”€â”´â”€â”€â”€â”  â”Œâ”€â”€â”€â”´â”€â”€â”€â”
        â”‚ Sub-A â”‚  â”‚ Sub-B â”‚
        â”‚EC2-A  â”‚  â”‚EC2-B  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§¹ Cleanup

* Terminate EC2 instances (private + bastion)
* Delete NAT Gateways
* Release Elastic IPs
* Delete route tables and VPC
